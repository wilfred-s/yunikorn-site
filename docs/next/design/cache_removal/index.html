<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.63">
<title data-react-helmet="true">Scheduler cache removal design | Apache YuniKorn (Incubating)</title><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" property="og:image" content="http://yunikorn.apache.org/img/logo/yunikorn-logo-main.png"><meta data-react-helmet="true" property="twitter:image" content="http://yunikorn.apache.org/img/logo/yunikorn-logo-main.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Apache YuniKorn (Incubating)"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Scheduler cache removal design | Apache YuniKorn (Incubating)"><meta data-react-helmet="true" name="description" content="&lt;!--"><meta data-react-helmet="true" property="og:description" content="&lt;!--"><meta data-react-helmet="true" property="og:url" content="http://yunikorn.apache.org/docs/next/design/cache_removal"><link data-react-helmet="true" rel="shortcut icon" href="/img/yunikorn.ico"><link data-react-helmet="true" rel="canonical" href="http://yunikorn.apache.org/docs/next/design/cache_removal"><link rel="stylesheet" href="/styles.3300edef.css">
<link rel="preload" href="/styles.42927ee7.js" as="script">
<link rel="preload" href="/runtime~main.1daa9f04.js" as="script">
<link rel="preload" href="/main.6222ead5.js" as="script">
<link rel="preload" href="/1.f2f38753.js" as="script">
<link rel="preload" href="/2.05510059.js" as="script">
<link rel="preload" href="/3.a37a1908.js" as="script">
<link rel="preload" href="/1be78505.e1f44db4.js" as="script">
<link rel="preload" href="/146.37105179.js" as="script">
<link rel="preload" href="/935f2afb.0d861f82.js" as="script">
<link rel="preload" href="/17896441.6af894f7.js" as="script">
<link rel="preload" href="/e5e048c5.74422a9c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/yunikorn.ico" alt="YuniKorn Site Logo"><strong class="navbar__title">Apache YuniKorn</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Quick Start</a><a class="navbar__item navbar__link" href="/community/roadmap">Roadmap</a><a class="navbar__item navbar__link" href="/community/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/community/get_involved">Get Involved</a></li><li><a class="dropdown__link" position="left" href="/community/how_to_contribute">How to Contribute</a></li><li><a class="dropdown__link" position="left" href="/community/coding_guidelines">Coding Guidelines</a></li><li><a class="dropdown__link" position="left" href="/community/reporting_issues">Reporting Issues</a></li><li><a class="dropdown__link" position="left" href="/community/sessions">Sessions and Demos</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Apache</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link" position="left">Apache Software Foundation</a></li><li><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link" position="left">Apache Incubator</a></li><li><a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener noreferrer" class="dropdown__link" position="left">Apache License</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link" position="left">Sponsorship</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" position="left" href="/docs/next/">Master</a></li><li><a class="dropdown__link" position="left" href="/docs/">0.10.0</a></li><li><a class="dropdown__link" position="left" href="/docs/0.9.0/">0.9.0</a></li><li><a class="dropdown__link" position="left" href="/docs/0.8.0/">0.8.0</a></li></ul></div><a href="https://github.com/apache/incubator-yunikorn-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/yunikorn.ico" alt="YuniKorn Site Logo"><strong class="navbar__title">Apache YuniKorn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" href="/community/roadmap">Roadmap</a></li><li class="menu__list-item"><a class="menu__link" href="/community/download">Download</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist">Community</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/community/get_involved">Get Involved</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/community/how_to_contribute">How to Contribute</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/community/coding_guidelines">Coding Guidelines</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/community/reporting_issues">Reporting Issues</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/community/sessions">Sessions and Demos</a></li></ul></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist">Apache</a><ul class="menu__list"><li class="menu__list-item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="menu__link" position="left">Apache Software Foundation</a></li><li class="menu__list-item"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="menu__link" position="left">Apache Incubator</a></li><li class="menu__list-item"><a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener noreferrer" class="menu__link" position="left">Apache License</a></li><li class="menu__list-item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="menu__link" position="left">Sponsorship</a></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" href="/docs">Docs</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" position="left" href="/docs/next/">Master</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/">0.10.0</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/0.9.0/">0.9.0</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/0.8.0/">0.8.0</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/apache/incubator-yunikorn-core" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Get Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/">Get Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/get_started/core_features">Features</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">User Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/queue_config">Partition and Queue Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/placement_rules">App Placement Rules</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/sorting_policies">Sorting Policies</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/acls">ACLs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/resource_quota_management">Resource Quota Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/gang_scheduling">Gang Scheduling</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Workloads</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/workloads/run_spark">Run Spark Jobs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/workloads/run_flink">Run Flink Jobs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/workloads/run_tf">Run Tensorflow Jobs</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">REST APIs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/api/cluster">Cluster</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/api/scheduler">Scheduler</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/api/system">System</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/user_guide/trouble_shooting">Trouble Shooting</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Developer Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/env_setup">Dev Environment Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/build">Build and Run</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/deployment">Deploy to Kubernetes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/developer_guide/openshift_development">Development in CodeReady Containers</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Designs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/architecture">Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/scheduler_core_design">Scheduler Core Design</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/next/design/cache_removal">Scheduler cache removal design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/k8shim">Kubernetes Shim Design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/cross_queue_preemption">Cross Queue Preemption</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/namespace_resource_quota">Namespace Resource Quota</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/pluggable_app_management">Pluggable App Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/resilience">Resilience</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/predicates">Support K8s Predicates</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/scheduler_configuration">Scheduler Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/state_aware_scheduling">Batch Workloads Ordering with StateAware Policy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/scheduler_object_states">Scheduler Object States</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/design/gang_scheduling">Gang scheduling design</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Performance</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/performance/evaluate_perf_function_with_kubemark">Evaluate YuniKorn function &amp; performance with Kubemark</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/performance/metrics">Scheduler Metrics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/next/performance/profiling">Profiling</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for Apache YuniKorn (Incubating) <strong>Next</strong> version.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/docs/design/cache_removal">latest version</a></strong> (0.10.0).</div></div><div class="docItemContainer_3QWW"><article><div><span class="badge badge--secondary">Version: Next</span></div><header><h1 class="docTitle_1Lrw">Scheduler cache removal design</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="proposal-to-combine-cache-and-schedulers-implementation-in-the-core"></a>Proposal to combine Cache and Scheduler&#x27;s implementation in the core<a aria-hidden="true" tabindex="-1" class="hash-link" href="#proposal-to-combine-cache-and-schedulers-implementation-in-the-core" title="Direct link to heading">#</a></h1><p>This document describes the current state of the scheduler and cache implementation.
It describes the changes planned based on the analysis that was done of the current behaviour.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="goals"></a>Goals<a aria-hidden="true" tabindex="-1" class="hash-link" href="#goals" title="Direct link to heading">#</a></h2><p>The goal is to provide the same functionality before and after the change.</p><ul><li>unit tests before and after the merge must all pass.</li><li>Smoke tests defined in the core should all pass without major changes <sup id="s1"><a href="#f1">definition</a></sup>.</li><li>End-to-end tests that are part of the shim code must all pass without changes.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="background"></a>Background<a aria-hidden="true" tabindex="-1" class="hash-link" href="#background" title="Direct link to heading">#</a></h2><p>The current Scheduler Core is build up around two major components to store the data: the cache and scheduler objects.
The cache objects form the base for most data to be tracked.
The Scheduler objects track specific in flight details and are build on top of a cache object.</p><p>The communication between the two layers uses a-synchronous events and in some cases direct updates.
A synchronous update between the scheduler and the cache does mean that there is a short period the scheduler is &quot;out of sync&quot; with the cache.
This short period can have an impact on the scheduling decisions.
One of which is logged as <a href="https://issues.apache.org/jira/browse/YUNIKORN-169" target="_blank" rel="noopener noreferrer">YUNIKORN-169</a>.</p><p>A further point is the complexity that the two structure brings to the code.
A distinct set of messages to communicate between the scheduler and the cache.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="a-one-on-one-mapping-between-the-scheduler-and-cache-objects-shows-that-the-distinction-is-probably-more-artificial-than-required"></a>A one on one mapping between the scheduler and cache objects shows that the distinction is probably more artificial than required.<a aria-hidden="true" tabindex="-1" class="hash-link" href="#a-one-on-one-mapping-between-the-scheduler-and-cache-objects-shows-that-the-distinction-is-probably-more-artificial-than-required" title="Direct link to heading">#</a></h2><b id="f1"></b>definition: Major changes for smoke tests are defined as changes to the tests that alter use case and thus test flows. Some changes will be needed as checks made could rely on cache objects which have been removed. [â†©](#s1) ## Structure analysis ### Objects The existing objects as per the code analysis. The overlap between the scheduler and the cache objects is shown by showing them at the same line. N/A means that there is no equivalent object in either the scheduler or cache.<table><thead><tr><th>Cache Object</th><th>Scheduler Object</th></tr></thead><tbody><tr><td>ClusterInfo</td><td>ClusterSchedulingContext</td></tr><tr><td>PartitionInfo</td><td>partitionSchedulingContext</td></tr><tr><td>AllocationInfo</td><td>schedulingAllocation</td></tr><tr><td>N/A</td><td>schedulingAllocationAsk</td></tr><tr><td>N/A</td><td>reservation</td></tr><tr><td>ApplicationInfo</td><td>SchedulingApplication</td></tr><tr><td>applicationState</td><td>N/A</td></tr><tr><td>NodeInfo</td><td>SchedulingNode</td></tr><tr><td>QueueInfo</td><td>SchedulingQueue</td></tr><tr><td>SchedulingObjectState</td><td>N/A</td></tr></tbody></table><p>The <code>initializer</code> code that is part of the cache does not define a specific object.
It contains a mixture of code defined at the package level and code that is part of the <code>ClusterInfo</code> object.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="events"></a>Events<a aria-hidden="true" tabindex="-1" class="hash-link" href="#events" title="Direct link to heading">#</a></h3><p>Events defined in the core have multiple origins and destinations.
Some events are only internal for the core between the cache and scheduler.
These events will be removed.</p><table><thead><tr><th>Event</th><th>Flow</th><th>Proposal</th></tr></thead><tbody><tr><td>AllocationProposalBundleEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>RejectedNewApplicationEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>ReleaseAllocationsEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>RemoveRMPartitionsEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>RemovedApplicationEvent</td><td>Scheduler -&gt; Cache</td><td>Remove</td></tr><tr><td>SchedulerNodeEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerAllocationUpdatesEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerApplicationsUpdateEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerUpdatePartitionsConfigEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>SchedulerDeletePartitionsConfigEvent</td><td>Cache -&gt; Scheduler</td><td>Remove</td></tr><tr><td>RMApplicationUpdateEvent (add/remove app)</td><td>Cache/Scheduler -&gt; RM</td><td>Modify</td></tr><tr><td>RMRejectedAllocationAskEvent</td><td>Cache/Scheduler -&gt; RM</td><td>Modify</td></tr><tr><td>RemoveRMPartitionsEvent</td><td>RM -&gt; Scheduler</td><td></td></tr><tr><td>RMUpdateRequestEvent</td><td>RM -&gt; Cache</td><td>Modify</td></tr><tr><td>RegisterRMEvent</td><td>RM -&gt; Cache</td><td>Modify</td></tr><tr><td>ConfigUpdateRMEvent</td><td>RM -&gt; Cache</td><td>Modify</td></tr><tr><td>RMNewAllocationsEvent</td><td>Cache -&gt; RM</td><td>Modify</td></tr><tr><td>RMReleaseAllocationEvent</td><td>Cache -&gt; RM</td><td>Modify</td></tr><tr><td>RMNodeUpdateEvent</td><td>Cache -&gt; RM</td><td>Modify</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>Events that are handled by the cache will need to be handled by the core code after the removal of the cache.
Two events are handled by the cache and the scheduler.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="detailed-flow-analysis"></a>Detailed flow analysis<a aria-hidden="true" tabindex="-1" class="hash-link" href="#detailed-flow-analysis" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="object-existing-in-both-cache-and-scheduler"></a>Object existing in both cache and scheduler<a aria-hidden="true" tabindex="-1" class="hash-link" href="#object-existing-in-both-cache-and-scheduler" title="Direct link to heading">#</a></h3><p>The current design is based on the fact that the cache object is the basis for all data storage.
Each cache object must have a corresponding scheduler object.
The contract in the core around the cache and scheduler objects was simple.
If the object exists in both scheduler and cache the object will be added to cache triggering the creation of the corresponding scheduler object.
Removing the object is always handled in reverse: first from the scheduler which will trigger the removal from the cache.
An example would be the creation of an application triggered by the <code>RMUpdateRequestEvent</code> would be processed by the cache.
Creating a <code>SchedulerApplicationsUpdateEvent</code> to create the corresponding application in the scheduler.</p><p>When the application and object state were added they were added into the cache objects.
The cache objects were considered the data store and thus also contain the state.
There were no corresponding state objects in the scheduler.
Maintaining two states for the same object is not possible. </p><p>The other exceptions to that rule are two objects that were considered volatile and scheduler only.
The <code>schedulingAllocationAsk</code> tracks outstanding requests for an application in the scheduler.
The <code>reservation</code> tracks a temporary reservation of a node for an application and ask combination. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="operations-to-addremove-app"></a>Operations to add/remove app<a aria-hidden="true" tabindex="-1" class="hash-link" href="#operations-to-addremove-app" title="Direct link to heading">#</a></h3><p>The RM (shim) sends a complex <code>UpdateRequest</code> as defined in the scheduler interface.
This message is wrapped by the RM proxy and forwarded to the cache for processing.
The RM can request an application to be added or removed.</p><p><strong>application add or delete</strong></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends cacheevent.RMUpdateRequestEvent to cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processApplicationUpdateFromRMUpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: Add new apps to the partition.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: Send removed apps to scheduler (but not remove anything from cache)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processApplicationUpdateEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: Add new apps to scheduler </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (when fails, send RejectedNewApplicationEvent to cache)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        No matter if failed or not, send RMApplicationUpdateEvent to RM.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: Remove app from scheduler</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Send RemovedApplicationEvent to cache</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="operations-to-remove-allocations-and-add-or-remove-asks"></a>Operations to remove allocations and add or remove asks<a aria-hidden="true" tabindex="-1" class="hash-link" href="#operations-to-remove-allocations-and-add-or-remove-asks" title="Direct link to heading">#</a></h3><p>The RM (shim) sends a complex <code>UpdateRequest</code> as defined in the scheduler interface.
This message is wrapped by the RM proxy and forwarded to the cache for processing.
The RM can request an allocation to be removed.
The RM can request an ask to be added or removed</p><p><strong>allocation delete</strong>
This describes the allocation delete initiated by the RM only</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends cacheevent.RMUpdateRequestEvent to cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewAndReleaseAllocationRequests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: (by-pass): Send to scheduler via event SchedulerAllocationUpdatesEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationUpdateEvent </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: Update ReconcilePlugin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: Send confirmation of the releases back to Cache via event ReleaseAllocationsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. cluster_info.processAllocationReleases to process the confirmed release</span></div></div></div></div></div><p><strong>ask add</strong>
If the ask already exists this add is automatically converted into an update.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends cacheevent.RMUpdateRequestEvent to cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewAndReleaseAllocationRequests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: Ask sanity check (such as existence of partition/app), rejections are send back to the RM via RMRejectedAllocationAskEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: pass checked asks to scheduler via SchedulerAllocationUpdatesEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationUpdateEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: Update scheduling application with the new or updated ask. </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: rejections are send back to the RM via RMRejectedAllocationAskEvent </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.3: accepted asks are not confirmed to RM or cache</span></div></div></div></div></div><p><strong>ask delete</strong></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends cacheevent.RMUpdateRequestEvent to cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewAndReleaseAllocationRequests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: (by-pass): Send to scheduler via event SchedulerAllocationUpdatesEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationReleaseByAllocationKey</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: Update scheduling application and remove the ask. </span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="operations-to-add-update-or-remove-nodes"></a>Operations to add, update or remove nodes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#operations-to-add-update-or-remove-nodes" title="Direct link to heading">#</a></h3><p>The RM (shim) sends a complex <code>UpdateRequest</code> as defined in the scheduler interface.
This message is wrapped by the RM proxy and forwarded to the cache for processing.
The RM can request a node to be added, updated or removed.</p><p><strong>node add</strong> </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends cacheevent.RMUpdateRequestEvent to cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNewSchedulableNodes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: node sanity check (such as existence of partition/node)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: Add new nodes to the partition.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: notify scheduler of new node via SchedulerNodeEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. notify RM of node additions and rejections via RMNodeUpdateEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: notify the scheduler of allocations to recover via SchedulerAllocationUpdatesEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. scheduler.processAllocationUpdateEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   4.1: scheduler creates a new ask based on the Allocation to recover </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   4.2: recover the allocation on the new node using a special process</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   4.3: confirm the allocation in the scheduler, on failure update the cache with a ReleaseAllocationsEvent</span></div></div></div></div></div><p><strong>node update and removal</strong></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends cacheevent.RMUpdateRequestEvent to cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processNodeActions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: node sanity check (such as existence of partition/node)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: Node info update (resource change)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        2.2.1: update node in cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        2.2.2: notify scheduler of the node update via SchedulerNodeEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: Node status update (not removal), update node status in cache only</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.4: Node removal</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        2.4.1: update node status and remove node from the cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        2.4.2: remove alloations and inform RM via RMReleaseAllocationEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        2.4.3: notify scheduler of the node removal via SchedulerNodeEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processNodeEvent add/remove/update the node  </span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="operations-to-add-update-or-remove-partitions"></a>Operations to add, update or remove partitions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#operations-to-add-update-or-remove-partitions" title="Direct link to heading">#</a></h3><p><strong>Add RM</strong></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends commonevents.RemoveRMPartitionsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if RM is already registered</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   1.1: scheduler.removePartitionsBelongToRM</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        1.1.1: scheduler cleans up</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        1.1.2: scheduler sends commonevents.RemoveRMPartitionsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   1.2: cluster_info.processRemoveRMPartitionsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        1.2.1: cache cleans up</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. RMProxy sends commonevents.RegisterRMEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. cluster_info.processRMRegistrationEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: cache update internal partitions/queues accordingly.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: cache sends to scheduler SchedulerUpdatePartitionsConfigEvent.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processUpdatePartitionConfigsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: Scheduler update partition/queue info accordingly.</span></div></div></div></div></div><p><strong>Update and Remove partition</strong>
Triggered by a configuration file update.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. RMProxy sends commonevents.ConfigUpdateRMEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processRMConfigUpdateEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: cache update internal partitions/queues accordingly.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: cache sends to scheduler SchedulerUpdatePartitionsConfigEvent.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: cache marks partitions for deletion (not removed yet).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.4: cache sends to scheduler SchedulerDeletePartitionsConfigEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processUpdatePartitionConfigsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: scheduler updates internal partitions/queues accordingly.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. scheduler.processDeletePartitionConfigsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   4.1: Scheduler set partitionManager.stop = true.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   4.2: PartitionManager removes queues, applications, nodes async.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        This is the REAL CLEANUP including the cache</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="allocations"></a>Allocations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#allocations" title="Direct link to heading">#</a></h3><p>Allocations are initiated by the scheduling process.
The scheduler creates a SchedulingAllocation on the scheduler side which then gets wrapped in an AllocationProposal.
The scheduler has checked resources etc already and marked the allocation as inflight.
This description picks up at the point the allocation will be confirmed and finalised.</p><p><strong>New allocation</strong></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. Scheduler wraps an SchedulingAllocation in an AllocationProposalBundleEvent </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. cluster_info.processAllocationProposalEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   preemption case: release preempted allocations</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.1: release the allocation in the cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.2: inform the scheduler the allocation is released via SchedulerNodeEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.3: inform the RM the allocation is released via RMReleaseAllocationEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   all cases: add the new allocation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.4: add the new allocation to the cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.5: rejections are send back to the scheduler via SchedulerAllocationUpdatesEvent </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.6: inform the scheduler the allocation is added via SchedulerAllocationUpdatesEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2.7: inform the RM the allocation is added via RMNewAllocationsEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. scheduler.processAllocationUpdateEvent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.1: confirmations are added to the scheduler and change from inflight to confirmed.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        On failure of processing a ReleaseAllocationsEvent is send to the cache *again* to clean up.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        This is part of the issue in [YUNIKORN-169]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        cluster_info.processAllocationReleases</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   3.2: rejections remove the inflight allocation from the scheduler. </span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="current-locking"></a>Current locking<a aria-hidden="true" tabindex="-1" class="hash-link" href="#current-locking" title="Direct link to heading">#</a></h2><p><strong>Cluster Lock:</strong><br>
A cluster contains one or more Partition objects. A partition is a sub object of Cluster.<br>
Adding or Removing ANY Partition requires a write-lock of the cluster.
Retrieving any object within the cluster will require iterating over the Partition list and thus a read-lock of the cluster</p><p><strong>Partition Lock:</strong><br>
The partition object contains all links to Queue, Application or Node objects.
Adding or Removing ANY Queue, Application or Node needs a write-lock of the partition.
Retrieving any object within the partition will require a read-lock of the partition to prevent data races</p><p>Examples of operation needing a write-lock</p><ul><li>Allocation processing after scheduling, will change application, queue and node objects.
Partition lock is required due to possible updates to reservations.</li><li>Update of Node Resource
It not only affect node&#x27;s available resource, it also affects the Partition&#x27;s total allocatable Resource </li></ul><p>Example of operations that need a read-lock:</p><ul><li>Retrieving any Queue, Application or Node needs a read-lock
The object itself is not locked as part of the retrieval</li><li>Confirming an allocation after processing in the cache
The partition is only locked for reading to allow retrieval of the objects that will be changed.
The changes are made on the underlying objects.</li></ul><p>Example of operations that do not need any lock: </p><ul><li>Scheduling<br>Locks are taken on the specific objects when needed, no direct updates to the partition until the allocation is confirmed. </li></ul><p><strong>Queue lock:</strong><br>
A queue can track either applications (leaf type) or other queues (parent type).
Resources are tracked for both types in the same way.</p><p>Adding or removing an Application (leaf type), or a direct child queue (parent type) requires a write-lock of the queue.<br>
Updating tracked resources requires a write-lock.
Changes are made recursively never locking more than 1 queue at a time.<br>
Updating any configuration property on the queue requires a write-lock.
Retrieving any configuration value, or tracked resource, application or queue requires a read-lock.  </p><p>Examples of operation needing a write-lock</p><ul><li>Adding an application to a leaf queue</li><li>Updating the reservations</li></ul><p>Examples of operation needing a read-lock</p><ul><li>Retrieving an application from a leaf type queue</li><li>Retrieving the pending resources </li></ul><p><strong>Application lock:</strong><br>
An application tracks resources of different types, the allocations and outstanding requests.<br>
Updating any tracked resources, allocations or requests requires a write-lock.
Retrieving any of those values requires a read-lock.</p><p>Scheduling also requires a write-lock of the application.
During scheduling the write-lock is held for the application.
Locks will be taken on the node or queue that need to be accessed or updated.<br>
Examples of the locks taken on other objects are:</p><ul><li>a read lock to access queue tracked resources</li><li>a write-lock to update the in progress allocations on the node </li></ul><p>Examples of operation needing a write-lock</p><ul><li>Adding a new ask</li><li>Trying to schedule a pending request </li></ul><p>Examples of operation needing a read-lock</p><ul><li>Retrieving the allocated resources</li><li>Retrieving the pending requests</li></ul><p><strong>Node lock:</strong><br>
An node tracks resources of different types and allocations.
Updating any tracked resources or allocations requires a write-lock.
Retrieving any of those values requires a read-lock.</p><p>Checks run during the allocation phases take locks as required.
Read-locks when checking write-locks when updating.
A node is not locked for the whole allocation cycle.</p><p>Examples of operation needing a write-lock</p><ul><li>Adding a new allocation</li><li>updating the node resources</li></ul><p>Examples of operation needing a read-lock</p><ul><li>Retrieving the allocated resources</li><li>Retrieving the reservation status</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-to-merge-cache-and-scheduler-objects"></a>How to merge Cache and scheduler objects<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-to-merge-cache-and-scheduler-objects" title="Direct link to heading">#</a></h2><p>Since there is no longer the requirement to distinguish the objects in the cache and scheduler the <code>scheduling</code> and <code>info</code> parts of the name will be dropped.</p><p>Overview of the main moves and merges:</p><ol><li><code>application_info</code> &amp; <code>scheduling_application</code>: <strong>merge</strong> to <code>scheduler.object.application</code></li><li><code>allocation_info</code> &amp; <code>scheduling_allocation</code>: <strong>merge</strong> to <code>scheduler.object.allocation</code></li><li><code>node_info</code> &amp; <code>scheduling_node</code>: <strong>merge</strong> to <code>scheduler.object.node</code></li><li><code>queue_info</code> &amp; <code>scheduling_queue</code>: <strong>merge</strong> to <code>scheduler.object.queue</code></li><li><code>partition_info</code> &amp; <code>scheduling_partition</code>: <strong>merge</strong> to <code>scheduler.PartitionContext</code></li><li><code>cluster_info</code> &amp; <code>scheduling_context</code>: <strong>merge</strong> to <code>scheduler.ClusterContext</code></li><li><code>application_state</code>: <strong>move</strong> to <code>scheduler.object.applicationState</code></li><li><code>object_state</code>: <strong>move</strong> to <code>scheduler.object.objectState</code></li><li><code>initializer</code>: <strong>merge</strong> into <code>scheduler.ClusterContext</code></li></ol><p>This move and merge of code includes a refactor of the objects into their own package.
That thus affects the two scheduler only objects, reservations and schedulingAsk, that are already defined.
Both will be moved into the objects package.</p><p>The top level scheduler package remains for the contexts and scheduling code.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="code-merges"></a>Code merges<a aria-hidden="true" tabindex="-1" class="hash-link" href="#code-merges" title="Direct link to heading">#</a></h2><p>The first change is the event processing.
All RM events will now directly be handled in the scheduler.
Event handling will undergo a major change, far more than a simple merge.
Only the RM generated events will be left after the merge.
As described in the analysis above the scheduler is, in almost all cases, notified of changes from RM events.</p><p>Broadly speaking there are only three types of changes triggered by the event removal: </p><ul><li>configuration changes: new scheduler code required as the cache handling is not transferable to the scheduler</li><li>node, ask and application changes: merge of the cache code into the scheduler</li><li>allocation changes: removal of confirmation cycle and simplification of the scheduler code</li></ul><p>Part of the event handling is the processing of the configuration changes.
All configuration changes will now update the scheduler objects directly.
The way the scheduler works is slightly different from the cache which means the code is not transferable. </p><p>Nodes and applications are really split between the cache and scheduler.
Anything that is tracked in the cache object that does not have an equivalent value in the scheduler object will be moved into the scheduler object.
All references to scheduler objects will be removed.
With the code merges existing scheduler code that calls out directly into the cache objects will return the newly tracked value in the scheduler object.
These calls will thus become locked calls in the scheduler.</p><p>The concept of an in flight allocation will be removed.
Allocation will be made in the same scheduling iteration without events or creation of a proposal.
Removing the need for tracking of allocating resources on the scheduler objects.
In flight resource tracking was required to make sure that an allocation while not confirmed by the cache would being taken into account while making scheduling decisions.</p><p>The application and object state will be an integrated part of the scheduler object.
A state change is thus immediate and this should prevent an issue like <a href="https://issues.apache.org/jira/browse/YUNIKORN-169" target="_blank" rel="noopener noreferrer">YUNIKORN-169</a> from occuring.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="locking-after-merge"></a>Locking after merge<a aria-hidden="true" tabindex="-1" class="hash-link" href="#locking-after-merge" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="direction-of-lock"></a>Direction of lock<a aria-hidden="true" tabindex="-1" class="hash-link" href="#direction-of-lock" title="Direct link to heading">#</a></h3><p>It is possible to acquire another lock while holding a lock, but we need to make sure that we do not allow: </p><ul><li>Holding A.lock and acquire B&#x27;s lock. </li><li>Holding B.lock and acquire B&#x27;s lock. </li></ul><p>The current code in the scheduler takes a lock as late as possible and only for the time period needed.
Some actions are not locked on the scheduler side just on the cache side as each object has its own lock.
This means that a read of a value from the cache would not lock the scheduling object.</p><p>With the integration of the cache into the scheduler the number of locks will decrease as the number of objects decreases.
Each equivalent object, cache and scheduler, which used to have their own lock will now have just one.
After the merge of the code is performed one lock will be left.
Locking will occur more frequently as the number of fields in the scheduler objects has increased.</p><p>Calls that did not lock the scheduler object before the merge will become locked.
Lock contention could lead to performance degradation.
The reduced overhead in objects and event handling can hopefully compensate for this.
One point to keep track of is the change in locking behaviour.
New behaviour could lead to new deadlock situations when code is simply merged without looking at the order.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="mitigations-for-deadlocks"></a>Mitigations for deadlocks<a aria-hidden="true" tabindex="-1" class="hash-link" href="#mitigations-for-deadlocks" title="Direct link to heading">#</a></h3><p>The locking inside the scheduler will be left as is.
This means that the main scheduling logic will be taking and releasing locks as required on the objects.
There are no long held read-locks or write-locks until the application is locked to schedule it.</p><p>A major point of attention will need to be that no iterations of objects should be performed while holding on to a lock.
For instance during scheduling while iterating over a queue&#x27;s application we should not lock the queue.</p><p>Another example would be that event processing in the partition should not lock the partition unneeded.
The partition should be locked while retrieving for instance the node that needs updating and release the lock before it tries to lock the node itself.</p><p>This approach fits in with the current locking approach and will keep the locking changes to a minimum.
Testing, specifically end-to-end testing, should catch these deadlocks.
There are no known tools that could be used to detect or describe lock order.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/next/design/scheduler_core_design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Scheduler Core Design</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/next/design/k8shim"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubernetes Shim Design Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goals" class="table-of-contents__link">Goals</a></li><li><a href="#background" class="table-of-contents__link">Background</a></li><li><a href="#a-one-on-one-mapping-between-the-scheduler-and-cache-objects-shows-that-the-distinction-is-probably-more-artificial-than-required" class="table-of-contents__link">A one on one mapping between the scheduler and cache objects shows that the distinction is probably more artificial than required.</a><ul><li><a href="#events" class="table-of-contents__link">Events</a></li></ul></li><li><a href="#detailed-flow-analysis" class="table-of-contents__link">Detailed flow analysis</a><ul><li><a href="#object-existing-in-both-cache-and-scheduler" class="table-of-contents__link">Object existing in both cache and scheduler</a></li><li><a href="#operations-to-addremove-app" class="table-of-contents__link">Operations to add/remove app</a></li><li><a href="#operations-to-remove-allocations-and-add-or-remove-asks" class="table-of-contents__link">Operations to remove allocations and add or remove asks</a></li><li><a href="#operations-to-add-update-or-remove-nodes" class="table-of-contents__link">Operations to add, update or remove nodes</a></li><li><a href="#operations-to-add-update-or-remove-partitions" class="table-of-contents__link">Operations to add, update or remove partitions</a></li><li><a href="#allocations" class="table-of-contents__link">Allocations</a></li></ul></li><li><a href="#current-locking" class="table-of-contents__link">Current locking</a></li><li><a href="#how-to-merge-cache-and-scheduler-objects" class="table-of-contents__link">How to merge Cache and scheduler objects</a></li><li><a href="#code-merges" class="table-of-contents__link">Code merges</a></li><li><a href="#locking-after-merge" class="table-of-contents__link">Locking after merge</a><ul><li><a href="#direction-of-lock" class="table-of-contents__link">Direction of lock</a></li><li><a href="#mitigations-for-deadlocks" class="table-of-contents__link">Mitigations for deadlocks</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Blog</h4><ul class="footer__items"><li class="footer__item"><a href="https://blog.cloudera.com/yunikorn-a-universal-resources-scheduler/" target="_blank" rel="noopener noreferrer" class="footer__link-item">What&#x27;s YuniKorn?</a></li><li class="footer__item"><a href="https://blog.cloudera.com/apache-yunikorn-incubating-0-8-release-whats-new-and-upcoming/" target="_blank" rel="noopener noreferrer" class="footer__link-item">What&#x27;s new in YuniKorn 0.8.0?</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Github</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-core/" target="_blank" rel="noopener noreferrer" class="footer__link-item">scheduler-core</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-k8shim" target="_blank" rel="noopener noreferrer" class="footer__link-item">kubernetes-shim</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-scheduler-interface" target="_blank" rel="noopener noreferrer" class="footer__link-item">scheduler-interface</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-yunikorn-web" target="_blank" rel="noopener noreferrer" class="footer__link-item">scheduler-web</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/get_involved">Get Involved</a></li><li class="footer__item"><a href="http://people.apache.org/phonebook.html?podling=yunikorn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Roster</a></li><li class="footer__item"><a href="https://issues.apache.org/jira/projects/YUNIKORN/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Apache Incubator Logo" src="https://incubator.apache.org/images/incubator_feather_egg_logo.png"></a></div><div>
Copyright Â© 2021 <a href="http://www.apache.org/">The Apache Software Foundation</a>. Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. <br>
<div style="padding:20px; margin: 10px; color: #4d4d4d;">
  Apache YuniKorn is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the name of Apache TLP sponsor.
  Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications,
  and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily
  a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
</div>
</div></div></div></footer></div>
<script src="/styles.42927ee7.js"></script>
<script src="/runtime~main.1daa9f04.js"></script>
<script src="/main.6222ead5.js"></script>
<script src="/1.f2f38753.js"></script>
<script src="/2.05510059.js"></script>
<script src="/3.a37a1908.js"></script>
<script src="/1be78505.e1f44db4.js"></script>
<script src="/146.37105179.js"></script>
<script src="/935f2afb.0d861f82.js"></script>
<script src="/17896441.6af894f7.js"></script>
<script src="/e5e048c5.74422a9c.js"></script>
</body>
</html>